import{bq as G,r as w,e as v,bi as f,el as re,a7 as oe,bd as E,i as de,$ as ue,L as he,u as _e,bK as me,a as ge,t as ve,d as pe,Z as fe,p as C,j as t,Q as be,dW as xe,C as Ce,bu as _,cq as ye,cu as V,az as k,c1 as $,z as y,b9 as H,c2 as p,ct as B,E as je,cv as S,by as W}from"./bundle.D3-hVUGj.js";import{u as $e}from"./payments-w44xId2A.js";import{u as Se,C as Ne}from"./usePaymentTypes-A7mRtALr.js";import{p as Ie}from"./atoms-6F-ixHOP.js";import{B as Fe}from"./Banner-C9ETM0xV.js";/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function Ee(){const h=G();return{find:d=>h.fetchQuery(["/api/v1/credits",d],()=>w("GET",v("/api/v1/credits/:id?include=client&sort=id|asc",{id:d})).then(o=>o.data.data),{staleTime:1/0})}}/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function Ve(){const h=G();return{find:d=>h.fetchQuery(["/api/v1/invoices",d],()=>w("GET",v("/api/v1/invoices/:id?include=client.group_settings&sort=id|asc",{id:d})).then(o=>o.data.data),{staleTime:1/0})}}/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function ke(h){const{payment:l,setPayment:d}=h;return{handleCreditChange:o=>{d(r=>r&&{...r,credits:[...r.credits,{_id:f(),amount:o.balance>0?o.balance:o.amount,credit_id:o.id}]})},handleExistingCreditChange:(o,r)=>{const i={...l};i.credits[r]={_id:f(),amount:o.balance>0?o.balance:o.amount,credit_id:o.id},d({...i})},handleCreditInputChange:(o,r)=>{const i={...l};i.credits[o].amount=r,d({...i})},handleDeletingCredit:o=>{d(r=>r&&{...r,credits:r.credits.filter(i=>i._id!==o)})}}}/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function Be(h){const{payment:l,setPayment:d}=h;return{handleInvoiceChange:o=>{d(r=>r&&{...r,invoices:[...r.invoices,{_id:f(),amount:o.balance>0?o.balance:o.amount,invoice_id:o.id}]})},handleExistingInvoiceChange:(o,r)=>{const i={...l};i.invoices[r]={_id:f(),amount:o.balance>0?o.balance:o.amount,invoice_id:o.id},d({...i})},handleInvoiceInputChange:(o,r)=>{const i={...l};i.invoices[o].amount=r,d({...i})},handleDeletingInvoice:o=>{d(r=>r&&{...r,invoices:r.invoices.filter(i=>i._id!==o)})}}}/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function we(){const h=re.sha256.create();return h.update(`${Date.now().toString()}${Math.random().toString()}`),h.hex()}/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function Me(h){const{setErrors:l,setIsFormBusy:d,isFormBusy:o}=h,r=oe();return(i,N)=>{if(!o){E.processing(),l(void 0),d(!0);const I=we();w("POST",v("/api/v1/payments?email_receipt=:email",{email:N}),{...i,idempotency_key:I}).then(m=>{E.success("created_payment"),r(de("/payments/:id/edit",{id:m.data.data.id}))}).catch(m=>{var j;((j=m.response)==null?void 0:j.status)===422&&(E.dismiss(),l(m.response.data))}).finally(()=>{d(!1),ue(["payments","credits","invoices","clients"])})}}}function De(){var A,O,P,L,D,R,q,Q,z;const{documentTitle:h}=he("create_payment"),[l]=_e(),[d]=me(),o=[{name:l("payments"),href:"/payments"},{name:l("new_payment"),href:"/payments/create"}],r=ge(),i=ve(),N=Ee(),I=Ve(),m=pe(),j=Se(),[e,g]=fe(Ie),[a,K]=C.useState(),[M,X]=C.useState(!1),[T,Z]=C.useState((A=i==null?void 0:i.settings)==null?void 0:A.client_manual_payment_notification),[J,U]=C.useState(!1),{data:F}=$e();C.useEffect(()=>{g(n=>{var s;let c=n;return d.get("action")!=="enter"&&d.get("action")!=="apply"&&(c=void 0),typeof F<"u"&&typeof c>"u"&&(c={...F.data.data,invoices:[],credits:[],client_id:"",type_id:((s=i==null?void 0:i.settings)==null?void 0:s.payment_type_id)??""}),c}),d.has("client")&&g(n=>n&&{...n,client_id:d.get("client")}),d.has("client")&&d.has("invoice")&&I.find(d.get("invoice")).then(n=>g(c=>c&&{...c,invoices:[{_id:f(),invoice_id:n.id,amount:n.balance>0?n.balance:n.amount}]})),d.has("client")&&d.has("credit")&&N.find(d.get("credit")).then(n=>g(c=>c&&{...c,credits:[{_id:f(),credit_id:n.id,amount:n.balance>0?n.balance:n.amount}]})),d.has("type")&&g(n=>n&&{...n,type_id:d.get("type")??""})},[F]);const{handleInvoiceChange:Y,handleExistingInvoiceChange:ee,handleInvoiceInputChange:ne,handleDeletingInvoice:te}=Be({payment:e,setPayment:g}),{handleCreditChange:ae,handleExistingCreditChange:ie,handleCreditInputChange:se,handleDeletingCredit:le}=ke({payment:e,setPayment:g}),u=(n,c)=>{g(s=>s&&{...s,[n]:c})},ce=Me({setErrors:K,setIsFormBusy:X,isFormBusy:M});return t.jsx(be,{title:h,breadcrumbs:o,onSaveClick:()=>ce(e,T),disableSaveButton:!e||M,aboveMainContainer:!!(e&&e.amount<0)&&t.jsx(Fe,{variant:"orange",style:{borderColor:r.$5},children:l("negative_payment_warning")}),children:t.jsx(xe,{breadcrumbs:[],children:t.jsxs(Ce,{title:l("enter_payment"),className:"shadow-sm",style:{borderColor:r.$24},headerStyle:{borderColor:r.$20},children:[t.jsx(_,{leftSide:l("client"),children:t.jsx(ye,{onChange:n=>{u("client_id",n==null?void 0:n.id),u("currency_id",(n==null?void 0:n.settings.currency_id)||"1"),u("invoices",[]),u("credits",[])},onClearButtonClick:()=>{u("client_id",""),u("currency_id",""),u("invoices",[]),u("credits",[])},errorMessage:a==null?void 0:a.errors.client_id,defaultValue:e==null?void 0:e.client_id,value:e==null?void 0:e.client_id,readonly:d.has("invoice")||d.get("action")==="enter"||d.get("action")==="apply",initiallyVisible:!(e!=null&&e.client_id)})}),t.jsx(_,{leftSide:l("amount_received"),leftSideHelp:l("amount_received_help"),children:t.jsx(V,{value:(e==null?void 0:e.amount)||"",onValueChange:n=>u("amount",isNaN(parseFloat(n))?0:parseFloat(n)),errorMessage:a==null?void 0:a.errors.amount,changeOverride:!0})}),(e==null?void 0:e.client_id)&&t.jsx(k,{}),e&&e.invoices.length>0&&e.invoices.map((n,c)=>t.jsx(_,{children:t.jsxs("div",{className:"flex flex-col",children:[t.jsxs("div",{className:"flex items-end space-x-2",children:[t.jsx($,{inputOptions:{value:n.invoice_id,label:l("invoice")??""},endpoint:v(`/api/v1/invoices?payable=${e.client_id}&per_page=100`),entryOptions:{label:"number",id:"id",value:"id",searchable:"number",dropdownLabelFn:s=>{var b,x;return`${l("invoice_number_short")}${s.number} - ${l("balance")} ${m(s.balance,(b=e.client)==null?void 0:b.country_id,(x=e.client)==null?void 0:x.settings.currency_id)}`},inputLabelFn:s=>s?`${l("invoice_number_short")}${s==null?void 0:s.number}`:""},onChange:s=>s.resource?ee(s.resource,c):null,exclude:y(e.invoices.filter(({invoice_id:s})=>s!==n.invoice_id)).pluck("invoice_id").toArray()}),t.jsx(V,{label:l("amount_received"),value:n.amount||"",onValueChange:s=>ne(c,isNaN(parseFloat(s))?0:parseFloat(s)),className:"w-full",withoutLabelWrapping:!0}),t.jsx("div",{className:"cursor-pointer self-center mt-6 focus:outline-none focus:ring-0",onClick:()=>te(n._id),children:t.jsx(H,{color:r.$16,hoverColor:r.$3,borderColor:r.$5,hoverBorderColor:r.$17,size:"1.6rem"})})]}),(a==null?void 0:a.errors[`invoices.${c}.amount`])&&t.jsx(p,{className:"mt-2",type:"danger",children:a==null?void 0:a.errors[`invoices.${c}.amount`]}),(a==null?void 0:a.errors[`invoices.${c}.invoice_id`])&&t.jsx(p,{className:"mt-2",type:"danger",children:a==null?void 0:a.errors[`invoices.${c}.invoice_id`]})]})},c)),(e==null?void 0:e.client_id)&&t.jsx(_,{leftSide:l("invoices"),children:t.jsx($,{endpoint:v(`/api/v1/invoices?payable=${e==null?void 0:e.client_id}&per_page=100`),inputOptions:{value:"id"},entryOptions:{id:"id",value:"id",label:"number",searchable:"number",dropdownLabelFn:n=>{var c,s;return`${l("invoice_number_short")}${n.number} - ${l("balance")} ${m(n.balance,(c=e.client)==null?void 0:c.country_id,(s=e.client)==null?void 0:s.settings.currency_id)}`}},onChange:({resource:n})=>n?Y(n):null,exclude:y(e.invoices).pluck("invoice_id").toArray(),clearInputAfterSelection:!0})}),(a==null?void 0:a.errors.invoices)&&t.jsx("div",{className:"px-6",children:t.jsx(p,{className:"mt-2",type:"danger",children:a==null?void 0:a.errors.invoices})}),(e==null?void 0:e.client_id)&&t.jsx(k,{}),e&&e.credits.length>0&&e.credits.map((n,c)=>t.jsx(_,{children:t.jsxs("div",{className:"flex flex-col",children:[t.jsxs("div",{className:"flex items-end space-x-2",children:[t.jsx($,{inputOptions:{value:n.credit_id,label:l("credit")??""},endpoint:v(`/api/v1/credits?client_id=${e.client_id}&per_page=100&applicable=true`),entryOptions:{id:"id",value:"id",label:"number",searchable:"number",dropdownLabelFn:s=>{var b,x;return`${l("credit")} #${s.number} - ${l("balance")} ${m(s.balance,(b=e.client)==null?void 0:b.country_id,(x=e.client)==null?void 0:x.settings.currency_id)}`}},onChange:s=>s.resource?ie(s.resource,c):null,exclude:y(e.credits.filter(({credit_id:s})=>s!==n.credit_id)).pluck("credit_id").toArray()}),t.jsx(V,{label:l("amount"),onValueChange:s=>se(c,isNaN(parseFloat(s))?0:parseFloat(s)),className:"w-full",value:n.amount||"",withoutLabelWrapping:!0}),t.jsx("div",{className:"cursor-pointer self-center mt-6 focus:outline-none focus:ring-0",onClick:()=>le(n._id),children:t.jsx(H,{color:r.$16,hoverColor:r.$3,borderColor:r.$5,hoverBorderColor:r.$17,size:"1.6rem"})})]}),(a==null?void 0:a.errors[`credits.${c}.amount`])&&t.jsx(p,{className:"mt-2",type:"danger",children:a==null?void 0:a.errors[`credits.${c}.amount`]}),(a==null?void 0:a.errors[`credits.${c}.credit_id`])&&t.jsx(p,{className:"mt-2",type:"danger",children:a==null?void 0:a.errors[`credits.${c}.credit_id`]})]})},c)),(e==null?void 0:e.client_id)&&t.jsx(_,{leftSide:l("credits"),children:t.jsx($,{endpoint:v(`/api/v1/credits?client_id=${e.client_id}&applicable=true`),inputOptions:{value:null},entryOptions:{id:"id",label:"number",value:"id",searchable:"number",dropdownLabelFn:n=>{var c,s;return`${l("credit")} #${n.number} - ${l("balance")} ${m(n.balance,(c=e.client)==null?void 0:c.country_id,(s=e.client)==null?void 0:s.settings.currency_id)}`}},onChange:n=>n.resource?ae(n.resource):null,exclude:y(e.credits).pluck("credit_id").toArray(),clearInputAfterSelection:!0})}),(a==null?void 0:a.errors.credits)&&t.jsx("div",{className:"px-6",children:t.jsx(p,{className:"mt-2",type:"danger",children:a==null?void 0:a.errors.credits})}),(e==null?void 0:e.client_id)&&t.jsx(k,{}),t.jsx(_,{leftSide:l("payment_date"),children:t.jsx(B,{type:"date",id:"date",value:e==null?void 0:e.date,onValueChange:n=>u("date",n),errorMessage:a==null?void 0:a.errors.date})}),t.jsx(_,{leftSide:l("payment_type"),children:t.jsx(je,{value:e==null?void 0:e.type_id,onValueChange:n=>u("type_id",n),errorMessage:a==null?void 0:a.errors.type_id,withBlank:!0,customSelector:!0,children:j.map(([n,c],s)=>t.jsx("option",{value:n,children:c},s))})}),t.jsx(_,{leftSide:l("transaction_reference"),children:t.jsx(B,{id:"transaction_reference",onValueChange:n=>u("transaction_reference",n),errorMessage:a==null?void 0:a.errors.transaction_reference})}),t.jsx(_,{leftSide:l("private_notes"),children:t.jsx(B,{element:"textarea",id:"private_notes",onValueChange:n=>u("private_notes",n),errorMessage:a==null?void 0:a.errors.private_notes})}),((O=i==null?void 0:i.custom_fields)==null?void 0:O.payment1)&&t.jsx(S,{field:"payment1",defaultValue:e==null?void 0:e.custom_value1,value:(P=i==null?void 0:i.custom_fields)==null?void 0:P.payment1,onValueChange:n=>u("custom_value1",n.toString())}),((L=i==null?void 0:i.custom_fields)==null?void 0:L.payment2)&&t.jsx(S,{field:"payment2",defaultValue:e==null?void 0:e.custom_value2,value:(D=i==null?void 0:i.custom_fields)==null?void 0:D.payment2,onValueChange:n=>u("custom_value2",n.toString())}),((R=i==null?void 0:i.custom_fields)==null?void 0:R.payment3)&&t.jsx(S,{field:"payment3",defaultValue:e==null?void 0:e.custom_value3,value:(q=i==null?void 0:i.custom_fields)==null?void 0:q.payment3,onValueChange:n=>u("custom_value3",n.toString())}),((Q=i==null?void 0:i.custom_fields)==null?void 0:Q.payment4)&&t.jsx(S,{field:"payment4",defaultValue:e==null?void 0:e.custom_value4,value:(z=i==null?void 0:i.custom_fields)==null?void 0:z.payment4,onValueChange:n=>u("custom_value4",n.toString())}),t.jsx(_,{leftSide:l("send_email"),children:t.jsx(W,{checked:T,onChange:Z})}),t.jsx(_,{leftSide:l("convert_currency"),children:t.jsx(W,{checked:!!(e!=null&&e.exchange_currency_id),onChange:n=>{U(n),n?u("exchange_currency_id","1"):u("exchange_currency_id",""),u("exchange_rate",1)}})}),J&&e&&t.jsx(Ne,{exchangeRate:e.exchange_rate.toString()||"1",exchangeCurrencyId:e.exchange_currency_id,currencyId:e.currency_id||"1",amount:y(e==null?void 0:e.invoices).sum("amount")+((e==null?void 0:e.amount)??0),onChange:(n,c)=>{u("exchange_rate",n),u("exchange_currency_id",c)},onExchangeRateChange:n=>u("exchange_rate",n)})]})})})}export{De as default};
