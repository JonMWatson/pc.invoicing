import{u as I,bO as B,a as M,p as $,a7 as z,d as O,en as P,bd as d,r as R,e as S,i as w,$ as L,eo as T,j as n,C as q,bu as r,c1 as Q,z as U,c2 as C,ct as X,cu as D,b9 as G,bi as H}from"./bundle.D3-hVUGj.js";import{b as J}from"./payments-w44xId2A.js";function Y(){var p,b,h,_,f,g,x,j;const[l]=I(),{id:v}=B(),c=M(),{data:e,isLoading:y}=J({id:v}),[o,m]=$.useState(),F=z(),u=O(),N=i=>{if(e){const s=(e==null?void 0:e.amount)-(e==null?void 0:e.applied);let a=0;return t.values.invoices.map(E=>{a=a+Number(E.amount)}),Math.min(s-a,i)}return i},A=()=>{if(e){const i=(e==null?void 0:e.amount)-(e==null?void 0:e.applied);let s=0;return t.values.invoices.map(a=>{s=s+Number(a.amount)}),i-s}return 0},t=P({enableReinitialize:!0,initialValues:{invoices:[]},onSubmit:i=>{d.processing(),m(void 0),R("PUT",S("/api/v1/payments/:id",{id:v}),i).then(s=>{d.success("updated_payment"),F(w("/payments/:id/edit",{id:s.data.data.id}))}).catch(s=>{var a;((a=s.response)==null?void 0:a.status)===422&&(m(s.response.data),d.dismiss())}).finally(()=>{t.setSubmitting(!1),L(["payments","invoices","clients","credits"])})}}),k=(i,s,a)=>{t.setFieldValue("invoices",[...t.values.invoices,{_id:H(),amount:s,credit_id:"",invoice_id:i,number:a}])},V=i=>{t.setFieldValue("invoices",t.values.invoices.filter(s=>s._id!==i))};return $.useEffect(()=>{let i=0;t.values.invoices.map(s=>{i=i+Number(s.amount)})},[t.values.invoices]),T({onClick:()=>t.submitForm(),disableSaveButton:t.isSubmitting},[t.values,t.isSubmitting]),n.jsxs(q,{title:l("apply_payment"),className:"shadow-sm",style:{borderColor:c.$24},headerStyle:{borderColor:c.$20},children:[n.jsx(r,{leftSide:l("number"),children:e==null?void 0:e.number}),e&&e.client&&n.jsxs(n.Fragment,{children:[n.jsx(r,{leftSide:l("amount"),children:u(e==null?void 0:e.amount,(p=e.client)==null?void 0:p.country_id,(b=e.client)==null?void 0:b.settings.currency_id)}),n.jsx(r,{leftSide:l("applied"),children:u(e==null?void 0:e.applied,(h=e.client)==null?void 0:h.country_id,(_=e.client)==null?void 0:_.settings.currency_id)}),n.jsxs(r,{leftSide:l("unapplied"),children:[u((e==null?void 0:e.amount)-(e==null?void 0:e.applied),(f=e.client)==null?void 0:f.country_id,(g=e.client)==null?void 0:g.settings.currency_id),t.values.invoices.length>=1&&`  - (${u(A(),(x=e.client)==null?void 0:x.country_id,(j=e.client)==null?void 0:j.settings.currency_id)} ${l("remaining")})`]})]}),n.jsxs(r,{leftSide:l("invoices"),children:[e!=null&&e.client_id?n.jsx(Q,{endpoint:S(`/api/v1/invoices?payable=${e==null?void 0:e.client_id}&per_page=100`),inputOptions:{value:"id"},entryOptions:{id:"id",value:"id",label:"name",searchable:"number",dropdownLabelFn:i=>{var s,a;return`${l("invoice_number_short")}${i.number} - ${l("balance")} ${u(i.balance,(s=e.client)==null?void 0:s.country_id,(a=e.client)==null?void 0:a.settings.currency_id)}`}},onChange:({resource:i})=>i?k(i.id,N(i.balance),i.number):null,initiallyVisible:y,exclude:U(t.values.invoices).pluck("invoice_id").toArray(),clearInputAfterSelection:!0}):null,(o==null?void 0:o.errors.invoices)&&n.jsx("div",{className:"py-2",children:n.jsx(C,{type:"danger",children:o.errors.invoices})})]}),t.values.invoices.map((i,s)=>n.jsxs(r,{leftSide:l("applied"),children:[n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx(X,{disabled:!0,label:l("invoice_number"),value:i.number}),n.jsx(D,{label:l("amount_received"),value:i.amount||"",onValueChange:a=>t.setFieldValue(`invoices.${s}.amount`,parseFloat(a))}),n.jsx("div",{className:"cursor-pointer focus:outline-none focus:ring-0 mt-6",onClick:()=>V(i._id),children:n.jsx(G,{color:c.$16,hoverColor:c.$3,borderColor:c.$5,hoverBorderColor:c.$17,size:"1.6rem"})})]}),(o==null?void 0:o.errors[`invoices.${[s]}.invoice_id`])&&n.jsx("div",{className:"py-2",children:n.jsx(C,{type:"danger",children:o.errors[`invoices.${[s]}.invoice_id`]})})]},s))]})}export{Y as default};
