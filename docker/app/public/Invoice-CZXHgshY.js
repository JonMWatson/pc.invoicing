import{bK as D,bL as X,bM as Z,ac as V,bN as ee,bd as g,r as I,e as N,$ as k,u as F,t as Q,Y as w,bp as O,bO as L,i as h,j as i,bP as se,bq as te,p as d,bc as U,L as ie,_ as ne,bQ as ae,av as oe,bi as ce,O as re,Q as le,bR as de,bS as ue,S as me,bA as fe,bT as ve,h as he,s as ye}from"./bundle.D3-hVUGj.js";import{u as pe}from"./Actions-OZ_Df7fS.js";import{C as _e}from"./CommonActions-DKlnNCPW.js";import{I as q}from"./invoice-status-We6cAxTk.js";import{u as be}from"./useInvoiceUtilities-CJ61_NPN.js";import{A as ge}from"./AddUninvoicedItemsButton-PnVaLqYv.js";import{B as xe}from"./Banner-C9ETM0xV.js";import{P as Ee}from"./PreviousNextNavigation-BpWEW6Fs.js";import"./hooks-DdpVpzmL.js";import"./CreditStatus-DFPZx7rF.js";import"./useInvoiceColumns-YKQxY9Gc.js";import"./InvoiceStatus-CQhnxHGD.js";/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function Se(y){const{setErrors:s,isDefaultTerms:n,isDefaultFooter:a,isFormBusy:o,setIsFormBusy:c}=y,[r]=D(),t=X(),p=Z(),u=V(ee);return async f=>{if(console.log("isFormBusy",o),o)return;g.processing(),s(void 0),c(!0),await t({excludeToasters:!0});let l="/api/v1/invoices/:id?";n?(l+="save_default_terms=true",a&&(l+="&save_default_footer=true")):a&&(l+="save_default_footer=true"),I("PUT",N(l,{id:f.id}),f).then(async()=>{(n||a)&&await p(),g.success("updated_invoice"),k(["products","invoices"]),r.get("action")==="add_tasks"&&k(["tasks"])}).catch(_=>{var m;if(((m=_.response)==null?void 0:m.status)===422){const e=_.response.data;e.errors.amount?g.error(e.errors.amount[0]):g.dismiss(),s(e)}}).finally(()=>{u(void 0),c(!1)})}}function je(y){var f;const[s]=F(),n=Q(),a=w(),o=O(),{id:c}=L(),{invoice:r,eInvoiceValidationResponse:t}=y,p=a("view_invoice")||a("edit_invoice")||o(r);return[{name:s("edit"),href:h("/invoices/:id/edit",{id:c})},{name:s("e_invoice"),href:h("/invoices/:id/e_invoice",{id:c}),enabled:!!((n==null?void 0:n.settings.e_invoice_type)==="PEPPOL"&&(n!=null&&n.settings.enable_e_invoice)&&((f=n==null?void 0:n.tax_data)!=null&&f.acts_as_sender)),formatName:()=>i.jsxs("div",{className:"flex space-x-1",children:[i.jsx("span",{children:s("e_invoice")}),!!(t!=null&&t.client.length||t!=null&&t.company.length||t!=null&&t.invoice.length)&&i.jsxs("span",{className:"font-bold",children:["(",((t==null?void 0:t.client.length)||0)+((t==null?void 0:t.company.length)||0)+((t==null?void 0:t.invoice.length)||0),")"]})]})},{name:s("documents"),href:h("/invoices/:id/documents",{id:c}),enabled:p,formatName:()=>{var l;return i.jsx(se,{numberOfDocuments:(l=r==null?void 0:r.documents)==null?void 0:l.length})}},{name:s("settings"),href:h("/invoices/:id/settings",{id:c})},{name:s("activity"),href:h("/invoices/:id/activity",{id:c})},{name:s("history"),href:h("/invoices/:id/history",{id:c})},{name:s("email_history"),href:h("/invoices/:id/email_history",{id:c})},{name:s("payments"),href:h("/invoices/:id/payments",{id:c}),enabled:(r==null?void 0:r.status_id)===q.Paid}]}/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function Ae(y){const{resource:s,enableQuery:n,onFinished:a}=y,o=!0,c=te(),[r,t]=d.useState(),p=async()=>{const u=await c.fetchQuery(["/api/v1/einvoice/validateEntity",s==null?void 0:s.id],()=>I("POST",N("/api/v1/einvoice/validateEntity"),{entity:"invoices",entity_id:s==null?void 0:s.id}).then(l=>l).catch(l=>l.response),{staleTime:1/0});let f={client:[],company:[],invoice:[],passes:!0};(u==null?void 0:u.status)===422&&(f={company:u.data.company??[],client:u.data.client??[],invoice:u.data.invoice??[],passes:!1}),t(U.cloneDeep(f)),a==null||a()};return d.useEffect(()=>{n&&s&&o&&p()},[n,s]),{validationResponse:r}}he.extend(ye);function Le(){var T;const{documentTitle:y}=ie("edit_invoice"),[s]=F(),n=d.useRef(null),{id:a}=L(),o=Q(),[c]=D(),r=w(),t=O(),p=pe(),[u,f]=d.useState(!1),[l,_]=d.useState(!0),{data:m}=ne({id:a,includeIsLocked:!0}),[e,x]=ae(oe,{disableFunctionality:a===(m==null?void 0:m.id)&&(m==null?void 0:m.is_locked)}),{validationResponse:E}=Ae({resource:e,enableQuery:(o==null?void 0:o.settings.e_invoice_type)==="PEPPOL"&&(o==null?void 0:o.settings.enable_e_invoice)&&((T=o==null?void 0:o.tax_data)==null?void 0:T.acts_as_sender)&&l&&a===(e==null?void 0:e.id),onFinished:()=>{_(!1)}}),[S,H]=d.useState(),{calculateInvoiceSum:M}=be({client:S}),[R,W]=d.useState(),[j,A]=d.useState(!1),[P,$]=d.useState(!1),[C,K]=d.useState(!1),Y=Se({setErrors:W,isDefaultTerms:P,isDefaultFooter:C,isFormBusy:u,setIsFormBusy:f}),z=je({invoice:e,eInvoiceValidationResponse:E}),G=[{name:s("invoices"),href:"/invoices"},{name:s("edit_invoice"),href:h("/invoices/:id/edit",{id:a})}];return d.useEffect(()=>{const b=c.get("action")&&e?e:m;if(b){const v=U.cloneDeep(b);v.line_items.map(J=>J._id=ce()),x(v),v!=null&&v.client&&H(v.client)}},[m]),d.useEffect(()=>{e&&M(e)},[e]),d.useEffect(()=>{j&&e&&(Y(e),A(!1))},[j]),re({on:["App\\Events\\Invoice\\InvoiceWasPaid"],callback:({data:B})=>{var b,v;((b=ve())==null?void 0:b.toString())!==B["x-socket-id"]&&((v=document.getElementById("invoiceUpdateBanner"))==null||v.classList.remove("hidden"))}}),i.jsxs(i.Fragment,{children:[i.jsx(le,{title:y,breadcrumbs:G,...(r("edit_invoice")||t(e))&&e&&{navigationTopRight:i.jsx(fe,{resource:e,actions:p,onSaveClick:()=>A(!0),disableSaveButton:e&&(e.status_id===q.Cancelled||e.is_deleted)||u,disableSaveButtonOnly:e.is_locked,cypressRef:"invoiceActionDropdown"})},aboveMainContainer:i.jsx(xe,{id:"invoiceUpdateBanner",className:"hidden",variant:"orange",children:s("invoice_status_changed")}),afterBreadcrumbs:i.jsx(Ee,{entity:"invoice"}),children:(e==null?void 0:e.id)===a?i.jsxs("div",{className:"space-y-2",children:[!!(e!=null&&e.is_locked)&&i.jsxs("div",{className:"flex items-center justify-center h-10 w-full text-white",style:{backgroundColor:"#4DA6FF"},children:[s("locked_invoice"),"."]}),i.jsxs("div",{className:"space-y-4",children:[i.jsx(de,{tabs:z,rightSide:e&&i.jsx("div",{className:"flex items-center",children:i.jsx(_e,{resource:e,entity:"invoice"})})}),i.jsx(ue,{context:{invoice:e,setInvoice:x,errors:R,isDefaultTerms:P,setIsDefaultTerms:$,isDefaultFooter:C,setIsDefaultFooter:K,client:S,eInvoiceRef:n,eInvoiceValidationEntityResponse:E,setTriggerValidationQuery:_}})]})]}):i.jsx("div",{className:"flex justify-center items-center",children:i.jsx(me,{})})}),i.jsx(ge,{invoice:e,setInvoice:x})]})}export{Le as default};
