import{u as B,bO as P,a as z,d as M,ep as O,p as d,a7 as T,en as H,bd as b,r as I,e as Q,$ as q,eo as D,j as i,C as L,bu as r,ct as f,E as U,c2 as g,az as y,cu as X,b9 as J,by as _,z as K}from"./bundle.D3-hVUGj.js";import{b as W}from"./payments-w44xId2A.js";function ee(){var p;const[l]=B(),{id:w}=P(),u=z(),{data:e}=W({id:w}),$=M(),{data:h}=O({id:e==null?void 0:e.company_gateway_id,queryParams:"include=gateway",enabled:!!(e!=null&&e.company_gateway_id)}),[n,j]=d.useState(),[v,x]=d.useState([]),[m,C]=d.useState(!1),[N,F]=d.useState(!1),[S,A]=d.useState(!1),E=T(),t=H({enableReinitialize:!0,initialValues:{id:e==null?void 0:e.id,date:e==null?void 0:e.date,invoices:[]},onSubmit:a=>{b.processing(),j(void 0);let s="/api/v1/payments/refund?&email_receipt=:email";S&&(s+="&gateway_refund=true"),I("POST",Q(s,{email:m}),a).then(()=>{b.success("refunded_payment"),E("/payments")}).catch(o=>{var c;((c=o.response)==null?void 0:c.status)===422&&(j(o.response.data),b.dismiss())}).finally(()=>{t.setSubmitting(!1),q(["payments"])})}}),k=a=>{const s=e==null?void 0:e.paymentables.find(({invoice_id:o})=>o===a.id);return s?s.amount-s.refunded:0},V=a=>{var o,c;const s=e==null?void 0:e.paymentables.find(({invoice_id:R})=>R===a.id);return s?`${l("invoice")} #${a.number} - ${l("refundable")} (${$(s.amount-s.refunded,(o=e==null?void 0:e.client)==null?void 0:o.country_id,(c=e==null?void 0:e.client)==null?void 0:c.settings.currency_id)})`:""};d.useEffect(()=>{e&&Array.isArray(e.invoices)&&v.map(a=>{const s=e.invoices.find(o=>o.id==a);s&&t.setFieldValue("invoices",[...t.values.invoices,{amount:k(s),invoice_id:s==null?void 0:s.id,id:""}])})},[v]),d.useEffect(()=>{let a=0;t.values.invoices.map(s=>{a=a+Number(s.amount),x(v.filter(o=>o!=s.invoice_id))})},[t.values.invoices]),d.useEffect(()=>{if(h){const a=h.data.data.gateway,s=Object.values(a.options).some(o=>o.refund);F(s)}},[h]);const G=()=>{var s;const a=K(t==null?void 0:t.values.invoices).pluck("invoice_id");return(s=e==null?void 0:e.invoices)==null?void 0:s.filter(o=>!a.contains(o.id))};return D({onClick:()=>t.handleSubmit(),disableSaveButton:t.isSubmitting||!t.values.invoices.length},[t.values,t.isSubmitting]),i.jsxs(L,{title:l("refund_payment"),className:"shadow-sm",style:{borderColor:u.$24},headerStyle:{borderColor:u.$20},children:[i.jsx(r,{leftSide:l("number"),children:i.jsx(f,{disabled:!0,value:e==null?void 0:e.number})}),e&&i.jsx(r,{leftSide:l("amount"),children:i.jsx(f,{disabled:!0,value:(e==null?void 0:e.amount)-(e==null?void 0:e.refunded)})}),i.jsx(r,{leftSide:l("applied"),children:i.jsx(f,{disabled:!0,value:e==null?void 0:e.applied})}),i.jsx(r,{leftSide:l("date"),children:i.jsx(f,{type:"date",value:t.values.date,onValueChange:a=>t.setFieldValue("date",a)})}),i.jsxs(r,{leftSide:l("invoices"),children:[i.jsx(U,{onValueChange:a=>{t.values.invoices.filter(s=>s.invoice_id==a).length<1&&x([...v,a])},withBlank:!0,customSelector:!0,clearAfterSelection:!0,children:(p=G())==null?void 0:p.map((a,s)=>i.jsx("option",{value:a.id,children:V(a)},s))}),(n==null?void 0:n.errors.invoices)&&i.jsx("div",{className:"py-2",children:i.jsx(g,{type:"danger",children:n.errors.invoices})})]}),i.jsx(y,{}),e&&Array.isArray(e.invoices)&&t.values.invoices.map((a,s)=>{const o=e.invoices.find(c=>c.id==a.invoice_id);if(o)return i.jsxs("div",{className:"flex flex-col",children:[i.jsx(r,{leftSide:`${l("invoice")}: ${o==null?void 0:o.number}`,children:i.jsxs("div",{className:"flex items-center space-x-2",children:[i.jsx(X,{value:t.values.invoices[s].amount||"",onValueChange:c=>t.setFieldValue(`invoices.${s}.amount`,parseFloat(c))}),i.jsx("div",{className:"cursor-pointer focus:outline-none focus:ring-0",onClick:()=>{t.setFieldValue("invoices",t.values.invoices.filter(c=>c.invoice_id!=a.invoice_id))},children:i.jsx(J,{color:u.$16,hoverColor:u.$3,borderColor:u.$5,hoverBorderColor:u.$17,size:"1.6rem"})})]})}),((n==null?void 0:n.errors[`invoices.${[s]}.invoice_id`])||(n==null?void 0:n.errors[`invoices.${[s]}.amount`]))&&i.jsx("div",{className:"px-6",children:i.jsx(g,{className:"mt-2 break-all",type:"danger",children:(n==null?void 0:n.errors[`invoices.${[s]}.invoice_id`])||(n==null?void 0:n.errors[`invoices.${[s]}.amount`])})})]},s)}),!!(e&&Array.isArray(e.invoices)&&t.values.invoices.length)&&i.jsx(y,{className:"pt-4",withoutPadding:!0}),i.jsx(r,{leftSide:l("send_email"),leftSideHelp:l("email_receipt"),children:i.jsx(_,{checked:m,onChange:()=>{C(!m)}})}),N&&i.jsx(r,{leftSide:l("gateway_refund"),leftSideHelp:l("gateway_refund_help"),children:i.jsx(_,{checked:S,onChange:a=>A(a)})}),(n==null?void 0:n.errors.id)&&i.jsx(g,{type:"danger",children:n.errors.id})]})}export{ee as default};
