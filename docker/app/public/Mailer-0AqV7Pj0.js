import{a7 as R,bd as b,r as T,e as C,$ as P,cl as M,cG as N,p as i,j as s,u as O,t as V,w as G,cF as D,C as v,bu as p,E as F,cx as H,cy as U,ct as E,cH as $,cI as k,cw as q,cJ as K,bc as z}from"./bundle.D3-hVUGj.js";import{I as A}from"./InvoiceViewer-CknzAqf8.js";/**
 * Invoice Ninja (https://invoiceninja.com).
 *
 * @link https://github.com/invoiceninja/invoiceninja source repository
 *
 * @copyright Copyright (c) 2022. Invoice Ninja LLC (https://invoiceninja.com)
 *
 * @license https://www.elastic.co/licensing/elastic-license
 */function J({setErrors:e}){const h=R();return(u,t,d,j,n,a,m)=>{b.processing(),e(void 0),T("POST",C("/api/v1/emails"),{body:u,entity:t,entity_id:d,subject:j,template:n,cc_email:m}).then(()=>{P([`${t}s`]),b.success("email_queued"),h(a)}).catch(l=>{var g;((g=l.response)==null?void 0:g.status)===422&&(e(l.response.data),b.dismiss())})}}function B(e){const h=M(),u=N(),[t,d]=i.useState(),[j,n]=i.useState("client_contact_id");return i.useEffect(()=>{e.resourceType==="purchase_order"&&e.resource.vendor_id.length>=1&&u.find(e.resource.vendor_id).then(a=>d(a)).then(()=>n("vendor_contact_id")),e.resourceType!=="purchase_order"&&e.resource.client_id.length>=1&&h.find(e.resource.client_id).then(a=>d(a)).then(()=>n("client_contact_id"))},[]),s.jsx(s.Fragment,{children:t&&s.jsx("div",{children:t.contacts.filter(a=>e.resource.invitations.find(m=>m[j]===a.id)).map((a,m)=>s.jsxs("p",{children:[a.first_name," ",a.last_name," Â·",s.jsxs("span",{className:"font-semibold",children:[" ",a.email]})]},m))})})}const W=i.forwardRef((e,h)=>{var y;const[u]=O(),t=V(),d=G(),j=D({resourceType:e.resourceType}),n=i.useRef(null),[a,m]=i.useState(),[l,g]=i.useState(),[x,f]=i.useState(!0),w=J({setErrors:m}),[r,_]=i.useState({body:"",ccEmail:"",subject:"",templateId:e.defaultEmail}),S=c=>{_(z.cloneDeep({body:"",ccEmail:"",subject:"",templateId:c})),f(!0)};return i.useEffect(()=>{var c;x&&(f(!1),b.processing(),n.current&&n.current.abort(),n.current=new AbortController,T("POST",C("/api/v1/templates"),{body:r.body,entity:e.resourceType,entity_id:((c=e.resource)==null?void 0:c.id)||"",subject:r.subject,template:r.templateId,cc_email:r.ccEmail},{signal:n.current?n.current.signal:void 0}).then(o=>{b.dismiss(),g(o.data)}))},[x,e.resourceType,(y=e.resource)==null?void 0:y.id]),i.useEffect(()=>{l&&_(c=>({...c,subject:l.raw_subject,body:l.raw_body,ccEmail:l.cc_email}))},[l]),i.useImperativeHandle(h,()=>({sendEmail(){var c;w(r.body,e.resourceType,((c=e.resource)==null?void 0:c.id)||"",r.subject,r.templateId,e.redirectUrl,r.ccEmail)}}),[r]),s.jsxs("div",{className:"grid grid-cols-12 lg:gap-4 my-4",children:[s.jsxs("div",{className:"col-span-12 lg:col-span-5 space-y-4",children:[s.jsxs(v,{children:[s.jsx(p,{leftSide:u("to"),children:s.jsx(B,{resource:e.resource,resourceType:e.resourceType})}),s.jsx(p,{leftSide:u("template"),children:s.jsxs(F,{defaultValue:r.templateId,onValueChange:c=>S(c),errorMessage:a==null?void 0:a.errors.template,children:[Object.entries(e.list).map(([c,o],I)=>s.jsx("option",{value:c,children:u(o)},I)),(t==null?void 0:t.settings.email_subject_custom1)&&s.jsx("option",{value:"email_template_custom1",children:t==null?void 0:t.settings.email_subject_custom1}),(t==null?void 0:t.settings.email_subject_custom2)&&s.jsx("option",{value:"email_template_custom2",children:t==null?void 0:t.settings.email_subject_custom2}),(t==null?void 0:t.settings.email_subject_custom3)&&s.jsx("option",{value:"email_template_custom3",children:t==null?void 0:t.settings.email_subject_custom3})]})})]}),s.jsxs(v,{withContainer:!0,children:[s.jsx(E,{label:u("cc_email"),value:r.ccEmail,onValueChange:c=>_(o=>({...o,ccEmail:c})),errorMessage:a==null?void 0:a.errors.cc_email}),s.jsx(E,{label:u("subject"),value:r.subject,onValueChange:c=>{_(o=>({...o,subject:c})),f(!0)},disabled:$()&&k(),changeOverride:!0,errorMessage:a==null?void 0:a.errors.subject}),(H()||U())&&s.jsx(q,{value:r.body,onChange:c=>{_(o=>({...o,body:c})),f(!0)},handleChangeOnlyOnUserInput:!0})]}),l&&s.jsx(v,{className:"scale-y-100",title:l.subject,children:s.jsx("iframe",{srcDoc:K(l.body,l.wrapper),width:"100%",height:800,tabIndex:-1,loading:"lazy"})})]}),s.jsx("div",{className:"my-4 lg:my-0 col-span-12 lg:col-span-7 h-max",children:e.resource&&(d==null?void 0:d.show_pdf_preview)&&s.jsx(A,{method:"GET",link:j(e.resource)})})]})});export{W as M};
